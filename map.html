<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Map</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        #error-message {
            display: none;
            text-align: center;
            color: red;
            font-size: 18px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <p id="error-message">‚ö†Ô∏è Unable to load the map. Please check your API key and internet connection.</p>

    <script>
        let map;
        const trustedOrigin = "https://editor.weweb.io/ad2de6c3-41cf-4baa-8085-d6d3eee08dd0/285d561d-38b0-4e5a-b167-3c19667e6188"; // üîí Update this to your parent application's URL

        function initMap() {
            try {
                console.log("Initializing Google Map...");
                map = new google.maps.Map(document.getElementById("map"), {
                    center: { lat: 37.7749, lng: -122.4194 }, // Default: San Francisco
                    zoom: 12,
                    fullscreenControl: false,
                    mapTypeControl: false
                });
                console.log("Map initialized");

                // Send initial map state to parent
                sendMapState();

                // Listen for map idle event (zoom/pan change)
                map.addListener("idle", sendMapState);

                // Listen for map click event
                map.addListener("click", function(event) {
                    const clickData = {
                        type: "map_click",
                        lat: event.latLng.lat(),
                        lng: event.latLng.lng()
                    };
                    
                    console.log("Map clicked:", clickData);
                    sendMessageToParent(clickData);
                });

                // Listen for messages from the parent app
                window.addEventListener("message", function(event) {
                    if (event.origin === trustedOrigin) {
                        handleParentMessage(event.data);
                    } else {
                        console.warn("Blocked message from untrusted origin:", event.origin);
                    }
                });

            } catch (error) {
                console.error("Error initializing map:", error);
                document.getElementById("map").style.display = "none";
                document.getElementById("error-message").style.display = "block";
            }
        }

        function sendMapState() {
            if (!map) return;

            const center = map.getCenter();
            const zoom = map.getZoom();
            const bounds = map.getBounds();

            const mapState = {
                type: "map_state_change",
                center: {
                    lat: center.lat(),
                    lng: center.lng()
                },
                zoom: zoom,
                bounds: bounds ? {
                    north: bounds.getNorthEast().lat(),
                    east: bounds.getNorthEast().lng(),
                    south: bounds.getSouthWest().lat(),
                    west: bounds.getSouthWest().lng()
                } : null
            };

            console.log("Map state changed:", mapState);
            sendMessageToParent(mapState);
        }

        function sendMessageToParent(data) {
            window.parent.postMessage(data, trustedOrigin);
            console.log("Sent message to parent:", data);
        }

        function handleParentMessage(data) {
            if (!map || !data) return;

            if (data.type === "set_center" && data.lat && data.lng) {
                map.setCenter({ lat: data.lat, lng: data.lng });
            }
            if (data.type === "set_zoom" && data.zoom) {
                map.setZoom(data.zoom);
            }
            if (data.type === "pan_to" && data.lat && data.lng) {
                map.panTo({ lat: data.lat, lng: data.lng });
            }
        }
    </script>

    <!-- Load Google Maps API (Replace with your actual API key) -->
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap" async defer></script>
</body>
</html>
